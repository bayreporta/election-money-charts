<link rel="stylesheet" href="http://oaktowndata.com/wp-content/themes/tiny-forge/chosen.css">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="http://oaktowndata.com/wp-content/js/tabletop.js"></script>
<script src="http://oaktowndata.com/wp-content/js/chosen.jquery.js"></script>
<script src="http://oaktowndata.com/wp-content/js/caltip.min.js"></script>
<style>
		#loading, #cand-nointerface {
			position:relative;
			height:300px;
			width:960px;
			top:0;
			left:0;
			text-align:center;
			margin:100px 0;
		}

			#loading h1, #cand-nointerface h1 {
				font-size:72px;
			}

			#loading p, #cand-nointerface p {
				font-size:48px;
			}


		#cand-nointerface {
			display:none;
		}
	/* --------STACKED BAR--------  */

		#cf-stacked {
			display:none;
			height:420px;
		}

			#cf-legend {
				width:960px;
				height:30px;
			}

				.cf-legend-opt {
					width:auto;
					height:20px;
					padding:5px;
					float:left;
					margin:0 20px;
					border:1px solid #8c9b93;
				}

					.cf-legend-opt p {
						text-align:center;
						font-size:12px;
						font-weight:700;
					}

					.cf-legend-opt:first-of-type {
						border:none;
						font-weight:700;
						margin:0 20px 0 262px;
					}

					.cf-legend-opt:nth-of-type(2) {
						background:#2b83ba;
					}

					.cf-legend-opt:nth-of-type(3) {
						background:#abdda4;
					}

					.cf-legend-opt:nth-of-type(4) {
						background:#fdae61;
					}

					.cf-legend-opt:nth-of-type(5) {
						background:#d7191c;
					}

			.stacked-bar-chart {
				width:960px;
			}

			.stacked-bar-chart .bar-data {
				width:600px;
			}

			.bar-seg {
				height:30px;
				float:left;
			}

			#oakland {
				background:#2b83ba;
			}

			#bayarea {
				background:#abdda4;
			}

			#cali {
				background:#fdae61;
			}

			#notcali {
				background:#d7191c;
			}


	/* --------CANDIDATE INTRO--------  */

		#cand-intro {
			padding-bottom: 20px;
			margin: 0 0 20px 0;
			display:none;
		}

			#cand-summary {
				width:700px;
				clear:right;
				line-height:18px;
				height:120px;
				margin:20px;
			}

				#cand-summary p {
					margin:0 0 15px 0;
				}

			#cand-header {
				width:540px;
			}

				#cand-header h2 {
					font-size:24px;
				}

				#cand-header h4 {
					font-size:16px;
					font-weight:300;
					color:#8c9b93;
					margin:10px 0 0 0;
				}


			#cand-photo {
				float:left;
				margin:20px;
				height:120px;
			}	

				#cand-photo img {
					border:1px solid #4c5b52;
					width:100px;
				}




		#cand-highlight {
			width:960px;
			height:300px;
			border-bottom:10px double #4c5b52;
			display:none;

		}

			#cand-highlight h2 {
				font-size:24px;
				margin:10px 0 0 0;
			}

			.highlights {
				float:left;
				width:300px;
				margin: 15px 19px 50px 0;
				height: 200px;
				border-right: solid 1px #8c9b93;
			}

			#cand-highlight div:last-of-type {
				border:none;
			}

				.highlights h4 {
					color:#4c5b52;
					font-size:67px;
					margin:50px 0 0 0;
					text-align:center;
				}

				.highlights p {
					color:#8c9b93;
					font-size:14px;
					margin:0 0 0 0;
					text-align:center;
				}

		#chart-footer {

		}		

	/* --------CF OVERVIEW--------  */
		#cf-container h2 {
			font-size:24px;
			margin:0 0 20px 0;
		}



		#cf-options {
			float:left;
			width:960px;
			margin:0 0 10px 0;
		}

			#cf-options img {
				width:100px;
				height:100px;
				cursor:pointer;
				border:1px solid #4c5b52;
				opacity:0.4;
			}

			#cf-options div {
				margin:20px 109px;
				float:left;
				width:100px;
				height:125px;
			}

			#cf-options h4 {
				width:80px;
				margin:0 10px;
				text-align:center;
				font-size:12px;
				color:#4c5b52;
			}

			#cf-options img:hover {
				opacity:1;
			}

		#cf-text {
			padding:20px 0 20px 0;
			border-bottom:solid 2px #4c5b52;
			line-height: 20px;
		}	

		#cand-chart {
			height:1px;
			border-bottom:solid 2px #4c5b52;
			border-top:10px double #4c5b52;
			visibility:hidden;
		}
		#cf-chart {
			height:1px;
			border-bottom:double 10px #4c5b52;
			border-top:10px double #4c5b52;
			visibility:hidden;
		}	

			#cf-choose {
				margin:10px 0 0 0;
				width:960px;
				height:35px;
			}

			#cf-draw {

			}

				#cf-summary {
					height:500px;
				}


				#cf-contribute {
					display:none;
					width:960px;
				}

				#cf-geography, #cf-sectors, #cf-expenses, #cf-achieve, #cf-employ {display:none;}


		.cf-detail {
			width: 200px;
			border: dashed 2px #4c5b52;
			float:left;
			padding: 0px;
			margin: 0 10px 0 0;
			cursor: pointer;
			background: #F8F7F1;
			text-align: center;
		}

				.cf-detail:hover {
					border:solid 2px #4c5b52;
				}

					.cf-detail p {
						color:#4C5B52;
						font-weight:900 !important;
						background:#d3d3d3;
					}

					.bar-chart {
						width:960px;
					}

					.cf-head {
						width:960px;
						height:120px;
					}

						.cf-title {
							width:960px;
						}

							.cf-title h2 {
								margin:0 0 0 0 !important;
								font-size:24px;
							}

							.cf-title h4 {
								margin:0 0 20px 0 !important;
							}


		.bar-row, .stacked-bar-row {
			width:891px;
			height:30px;
			margin:0 0 15px 0;

		}

		.pointer {
			cursor:pointer;

		}


		.bar-label {
			width:250px;
			height:50px;
			font-size:12px;
			text-align:right;
			border-right:1px solid #000;
			padding:0 10px 0 0;
			height:100%;
			float:left;
			margin:0 0 0 0;

		}

			.bar-label p {
				margin:10px 0
			}

		.bar-data {
			width:0;
			height:30px;
			background:#91cf60;
			float:left;
		}

			.bar-data p {
				text-align:right;
				font-size:14px;
				margin:6px 5px 6px 0;
				color:#000000;
				font-weight:700;
			}

		.chart-h4 {
			text-align: center;
			font-size: 36px;
			color: #91cf60;
		}

		.cf-infobox {
			float:left;
			width:280px;
			height:auto;
			margin:10px 10px 10px 10px;
			padding:8px;
			border:2px solid #8c9b93;
		}	

			.cf-infobox h4 {
				font-weight:400;
				font-size:18px;
				margin-bottom:10px;
			}

			.cf-infobox li span:first-of-type {
				font-weight:700;
			}


		#cf-industry, #cf-industry .drill-bar-chart {
			display:none;
		}

		.chart-footer {
			font-style:italic;
			font-size:12px;
			color:#8c9b93;
			margin:30px 0 0 0;
		}
</style>

<div>
	<div id="loading">
		<h1><strong></strong></h1>
		<p>this should only take a moment</p>
	</div>
	<div id="cf-chart">
		<div id="cf-choose">
			<select id="race-options" class="chosen-select" style="width:200px;float:left;" tabindex="2">
				<option value="All">All</option>
				<option value="District Attorney">District Attorney</option>
				<option value="Supervisor: District 4">Supervisor: District 4</option>
				<option value="Supervisor: District 5">Supervisor: District 5</option>
			</select>
			<select id="overall-options" class="chosen-select" style="width:200px;float:left;" tabindex="2">
				<option value="Cash Raised">Cash Raised</option>
				<option value="Cash Spent">Cash Spent</option>
				<option value="Contributors">Top Contributors</option>
				<option value="Sectors">Geography</option>
			</select>
		</div>
		<div id="cf-summary" class="cf-canvas">
			<div class="bar-chart">
				<div class="cf-head">
					<div class="cf-title">
						<h2>Total Cash Raised 2013-2014</h2>
						<h4>Last Report 1/30/2014</h4>
					</div>
				</div>	
				<div class="bar-row" id="1">
					<div class="bar-label">
						<p class="the-label">Patrick McCullough</p>
					</div>
					<div class="bar-data">
						<p></p>
					</div>
				</div>
				<div class="bar-row" id="2">
					<div class="bar-label">
						<p class="the-label">Bryan Parker</p>
					</div>
					<div class="bar-data">
						<p></p>
					</div>
				</div>
				<div class="bar-row" id="3">
					<div class="bar-label">
						<p class="the-label">Jean Quan</p>
					</div>
					<div class="bar-data">
						<p></p>
					</div>
				</div>
				<div class="bar-row" id="4">
					<div class="bar-label">
						<p class="the-label">Libby Schaaf</p>
					</div>
					<div class="bar-data">
						<p></p>
					</div>
				</div>
				<div class="bar-row" id="5">
					<div class="bar-label">
						<p class="the-label">Dan Siegel</p>
					</div>
					<div class="bar-data">
						<p></p>
					</div>
				</div>
				<div class="bar-row" id="6">
					<div class="bar-label">
						<p class="the-label">Joe Tuman</p>
					</div>
					<div class="bar-data">
						<p></p>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
	// ------- GLOBAL ------- //
		var gsheet = "https://docs.google.com/spreadsheet/pub?key=0AnZDmytGK63SdFo3Tnl5cmpnZXUydVloYUZSZnR5RHc&output=html";
		var candidateDB = [];
		var candidates = {
			all:8,
			da:4,
			dfour:2,
			dfive:2
		};
		var maxBarWidth = 400;
		var updated = "3/17/2014";
		var mayoralCand = [];
		var currentBars = 6;
		var view = "Cash Raised";
		var race = "All";
		var raceTotal = candidates.all;
		
	// ------- CHOSEN ------- //	
		$(document).ready(function(){
			var config = {
		      '.chosen-select'           : {},
		      '.chosen-select-deselect'  : {allow_single_deselect:true},
		      '.chosen-select-no-single' : {disable_search_threshold:10},
		      '.chosen-select-no-results': {no_results_text:'Oops, nothing found!'},
		      '.chosen-select-width'     : {width:"95%"}
		    }
		    for (var selector in config) {
		      $(selector).chosen(config[selector]);
		    }
		});

	// ------- FUNNY GREETINGS ------- //
		$(document).ready(function(){
			var random = Math.round(Math.random() * 10);
			if (random === 0){
				$("#loading h1:eq(0)").html("Scanning Disclosure Forms...");
			}
			else if (random === 1){
				$("#loading h1:eq(0)").html("Lubricating Political Wheels...");
			} 
			else if (random === 2){
				$("#loading h1:eq(0)").html("Connecting to Central Server...");
			}
			else if (random === 3){
				$("#loading h1:eq(0)").html("Circumventing NSA Snooping...");
			}
			else if (random === 4){
				$("#loading h1:eq(0)").html("Consulting Consultants...");
			}
			else if (random === 5){
				$("#loading h1:eq(0)").html("Populating Plazoids...");
			}
			else if (random === 6){
				$("#loading h1:eq(0)").html("Sizing Up War Chests...");
			}
			else if (random === 7){
				$("#loading h1:eq(0)").html("Crossing T's and Dotting I's...");
			}
			else if (random === 8){
				$("#loading h1:eq(0)").html("Verifying Accounting...");
			}
			else if (random === 9){
				$("#loading h1:eq(0)").html("Handshaking Good Ole Boys...");
			}
			else if (random === 10){
				$("#loading h1:eq(0)").html("Communicating Telepathically...");
			}
		});

	// ------- TABLETOP ------- //
		$(document).ready(function(){
				Tabletop.init( { key: gsheet,
			                     callback: setTheScene,
			                     wanted: ["Summary"],
			                     debug: true } );
		});

	// ------- GET AND POPULATE CANDIDATE INFO ------- //

		function setTheScene(data, tabletop){
			//pull spreadsheet data into arrays
			$.each( tabletop.sheets("Summary").all(), function(i, summary) {
				var insertRow = [];
				insertRow[0] = summary.category;
				insertRow[1] = summary.all;
				insertRow[2] = summary.bass;
				insertRow[3] = summary.kerrigan;
				insertRow[4] = summary.latour;
				insertRow[5] = summary.sundberg;
				insertRow[6] = summary.dollison;
				insertRow[7] = summary.firpo;
				insertRow[8] = summary.fleming;
				insertRow[9] = summary.klein;
				candidateDB.push(insertRow);
			});
						
			
			//when last updated
			$(".cf-title h4").html("Data Updated on " + updated); 

			//loading
			$("#cf-chart").css("visibility","visible").css("height","auto");
			$("#loading").remove();
			
			//draw first chart
			resetSummaryBars(view);
			renameSummaryLabels(view);
			$(".cf-canvas").css("display","none");
			$("#cf-summary").css("display","block").animate({
				height:500
			});
			drawContributions()
		}

		function drawContributions(){
			var data = [];
			var dataWidth = [];
			var commas = [];

			//size up data
			for (i=0 ; i < raceTotal; i++){
				var ii = i+2;
				data[i] = parseInt(candidateDB[5][ii]);
				commas[i] = commaSeparateNumber(data[i]);
			}
			console.log(data)
			
			//find highest value in array
			var maxValue = Math.max.apply(null, data);
			
			//figure out the width for each bar
			for (i = 0 ; i < data.length ; i++){
				dataWidth[i] = (data[i] / maxValue) * maxBarWidth;
				console.log(dataWidth[i])
			}

			//populate data
			for (i=0 ; i < data.length ; i++){
				$("#cf-summary .bar-row:eq(" + i + ")").attr("value",data[i]);
				$("#cf-summary .bar-data:eq(" + i + ") p").text("$" + commas[i]);
				$("#cf-summary .bar-data:eq(" + i + ")").animate({
					width:dataWidth[i]
				})
			}
			
			//meta
			$("#cf-summary .cf-title h2").text("Total Cash Raised 2013-14");
			$("#cf-summary").append("<h4 class=\"chart-h4\">$" + commaSeparateNumber(data[0] + data[1] + data[2] + data[3] + data[4] + data[5]) + " contributed total</h4>");
			$("#cf-summary").append("<p class=\"chart-footer\">Cash raised includes all cash raised by the candidate excluding non-monetary contributions and loans.</p>");
			sortBars();
		}

		function drawSpent(){
			var data = [];
			var dataWidth = [];
			var commas = [];

			//size up data
			for (i=0 ; i < 6 ; i++){
				var ii = i+8;
				data[i] = candidateDB[ii][1];
				commas[i] = commaSeparateNumber(candidateDB[ii][1]);

			}

			var maxValue = Math.max.apply(null, data);
			for (i = 0 ; i < data.length ; i++){
				dataWidth[i] = (data[i] / maxValue) * maxBarWidth;
			}

			//populate data
			for (i=0 ; i < data.length ; i++){
				$("#cf-summary .bar-row:eq(" + i + ")").attr("value",data[i]);
				$("#cf-summary .bar-data:eq(" + i + ") p").text("$" + commas[i]);
				$("#cf-summary .bar-data:eq(" + i + ")").animate({
					width:dataWidth[i]
				})
			}
			$("#cf-summary .bar-data").css("background","#fc8d59");
			$("#cf-summary .cf-title h2").text("Total Cash Spent 2013-14");
			$("#cf-summary").append("<h4 class=\"chart-h4\" style=\"color:#fc8d59;\">$" + commaSeparateNumber(data[0] + data[1] + data[2] + data[3] + data[4] + data[5]) + " spent total</h4>");
			$("#cf-summary").append("<p class=\"chart-footer\">Cash spent includes all expenses excluding accured expenses.</p>");
			sortBars();
		}

		function drawGeography(){
				var data = [];
				var dataWidth = [];
				var total = [];
				var commas = [];


				//size up data
				for (i=0 ; i < 24 ; i++){
					var ii = i+205;
					data[i] = candidateDB[ii][1];
					commas[i] = commaSeparateNumber(candidateDB[ii][1]);
				}

				var ii= 0;
				var iii = 1;
				var iv = 2;
				var v = 3;
				for (i=0 ; i < 6 ; i++){
					total[i] = (data[ii] + data[iii] + data[iv] + data[v]);
					ii = ii + 4;
					iii = iii +4;
					iv = iv +4;
					v = v +4;
				}


				//populate data
				$("#cf-stacked .stacked-bar-row:eq(0)").attr("value",((data[0] / total[0]) * 100));
				$("#cf-stacked .stacked-bar-row:eq(1)").attr("value",((data[4] / total[1]) * 100));
				$("#cf-stacked .stacked-bar-row:eq(2)").attr("value",((data[8] / total[2]) * 100));
				$("#cf-stacked .stacked-bar-row:eq(3)").attr("value",((data[12] / total[3]) * 100));
				$("#cf-stacked .stacked-bar-row:eq(4)").attr("value",((data[16] / total[4]) * 100));
				$("#cf-stacked .stacked-bar-row:eq(5)").attr("value",((data[20] / total[5]) * 100));

				ii=0
				iii = 1;
				iv = 2;
				v = 3;
				for (i=0 ; i < 6 ; i++){
					$("#cf-stacked .bar-data:eq(" + i + ") .bar-seg:eq(0)").animate({
						width:((data[ii] / total[i]) * 100) + "%"
					})
					$("#cf-stacked .bar-data:eq(" + i + ") .bar-seg:eq(0)").caltip({
						title:"Oakland",
						content:"$" + commas[ii] + " (" + Math.round(((data[ii] / total[i]) * 100)) + "%" + ")"
					})
					$("#cf-stacked .bar-data:eq(" + i + ") .bar-seg:eq(1)").animate({
						width:((data[iii] / total[i]) * 100) + "%"
					})
					$("#cf-stacked .bar-data:eq(" + i + ") .bar-seg:eq(1)").caltip({
						title:"Bay Area",
						content:"$" + commas[iii] + " (" + Math.round(((data[iii] / total[i]) * 100)) + "%" + ")"
					})
					$("#cf-stacked .bar-data:eq(" + i + ") .bar-seg:eq(2)").animate({
						width:((data[iv] / total[i]) * 100) + "%"
					})
					$("#cf-stacked .bar-data:eq(" + i + ") .bar-seg:eq(2)").caltip({
						title:"California",
						content:"$" + commas[iv] + " (" + Math.round(((data[iv] / total[i]) * 100)) + "%" + ")"
					})
					$("#cf-stacked .bar-data:eq(" + i + ") .bar-seg:eq(3)").animate({
						width:((data[v] / total[i]) * 100) + "%"
					})
					$("#cf-stacked .bar-data:eq(" + i + ") .bar-seg:eq(3)").caltip({
						title:"Outside California",
						content:"$" + commas[v] + " (" + Math.round(((data[v] / total[i]) * 100)) + "%" + ")"
					})
					ii = ii + 4;
					iii = iii +4;
					iv = iv +4;
					v = v +4;
				}
				//adjust for siegel
				$("#cf-stacked .stacked-bar-row:eq(4)").remove();
				$("#cf-stacked").append("<p class=\"chart-footer\">Bay Area contributions include contributions from all cities in the North, South and East Bay, including the Peninsula EXCLUDING Oakland. California contributions include all contributions from California EXCLUDING Bay Area. Candidates with no contributions excluded from chart.</p>");
				sortGeo();
		}

		function resetSummaryBars(view){
			//reset text and colors for chart
			$(".chart-h4").remove();
			$(".chart-footer").remove();
			$(".bar-row").remove();

			if (view === "Cash Raised"){
				for (i = 1 ; i < raceTotal; i++){
					$("#cf-summary .bar-chart").append("<div class=\"bar-row\" id=\"" + i + "\"><div class=\"bar-label\"><p class=\"the-label\"></p></div><div class=\"bar-data\"><p></p></div></div>");
				}
			}
			else if (view === "Cash Spent"){
				for (i = 1 ; i < raceTotal; i++){
					$("#cf-summary .bar-chart").append("<div class=\"bar-row\" id=\"" + i + "\"><div class=\"bar-label\"><p class=\"the-label\"></p></div><div class=\"bar-data\"><p></p></div></div>");
				}
			}		
		}

		function renameSummaryLabels(view){
			for (i = 0; i < raceTotal; i++){
				var ii=i+2;
				$("#cf-summary .bar-row:eq("+ i +") .bar-label p").html(candidateDB[0][ii]);
			}
		}

		function sortBars(){
			var $wrapper = $('.bar-chart'),
		        $articles = $wrapper.find('.bar-row');
		    [].sort.call($articles, function(a,b) {
		        return +$(b).attr('value') - +$(a).attr('value');
		    });
		    $articles.each(function(){
		        $wrapper.append(this);
		    });
		}

		function sortIndustry(){
			var $wrapper = $('.drill-bar-chart'),
		        $articles = $wrapper.find('.bar-row');
		    [].sort.call($articles, function(a,b) {
		        return +$(b).attr('value') - +$(a).attr('value');
		    });
		    $articles.each(function(){
		        $wrapper.append(this);
		    });
		}

		function sortGeo(){
			var $wrapper = $('.stacked-bar-chart'),
		        $articles = $wrapper.find('.stacked-bar-row');
		    [].sort.call($articles, function(a,b) {
		        return +$(b).attr('value') - +$(a).attr('value');
		    });
		    $articles.each(function(){
		        $wrapper.append(this);
		    });
		}

	// ------- COMMAS!!------- //

		function commaSeparateNumber(val){
		    while (/(\d+)(\d{3})/.test(val.toString())){
		      val = val.toString().replace(/(\d+)(\d{3})/, '$1'+','+'$2');
		    }
		    return val;
		}
	

	// ------- CHART BACK TO SECTOR FROM INDUSTRY------- //
		$(document).ready(function(){
			$(".cf-detail").on("click", function(){
				$("#cf-summary .bar-chart").css("display","block");
				$("#cf-industry .drill-bar-chart").css("display","none");
				$("#cf-summary").css("display","block");
				$("#cf-industry").css("display","none");
				resetSummaryBars(view)
				renameSummaryLabels(view);
				$(".cf-canvas").css("display","none");					
				$("#cf-summary").css("display","block").animate({
					height:1125
				});
				drawSectors()
			})
		});

	// ------- CHART SHIFTING------- //
		$(document).ready(function(){
			$("#overall_options_chosen").on("click","ul > li", function(){
				view = $(this).html(); //detect view

				//magically hide and show chart divs
				$("#cf-summary .bar-chart").css("display","block");
				$("#cf-industry .drill-bar-chart").css("display","none");
				$("#cf-summary").css("display","block");
				$("#cf-industry").css("display","none");

				//Change view
				if (view === "Cash Raised"){
					resetSummaryBars(view);
					renameSummaryLabels(view);
					$(".cf-canvas").css("display","none");
					$("#cf-summary").css("display","block").animate({
						height:500
					});
					drawContributions()
				}
				else if (view === "Top Contributors"){
					resetSummaryBars(view);
					renameSummaryLabels(view);
					$(".cf-canvas").css("display","none");
					$("#cf-contribute").css("display","block").animate({
						height:400
					});
					$("#cf-contribute").append("<p class=\"chart-footer\">Top employers include the total number of contributions from both individuals who work for the employer and contributions made by the employer itself. Contributions where a person who identified themself as Retired have been excluded from this list as it is an entire category in and of itself. Average amount per contribution based off of all reported contributions; contributions under $100 typically don't have to be reported.</p>");
				}
				else if (view === "Geography"){
					$(".cf-canvas").css("display","none");
					$("#cf-stacked").css("display","block").animate({
						height:420
					});
					drawGeography();
				}
				else if (view === "Sectors/Industries"){
					resetSummaryBars(view)
					renameSummaryLabels(view);
					$(".cf-canvas").css("display","none");					
					$("#cf-summary").css("display","block").animate({
						height:1075
					});
					drawSectors()
				}
				else if (view === "Cash Spent"){
					resetSummaryBars(view)
					renameSummaryLabels(view);
					$(".cf-canvas").css("display","none");
					$("#cf-summary").css("display","block").animate({
						height:500
					});
					drawSpent()
				}
				else if (view === "Achievements"){
					$(".cf-canvas").css("display","none");
					$("#cf-achieve").css("display","block").animate({
						height:300
					});
				}
			})
		});
	
</script>